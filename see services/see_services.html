<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetCare Finder - 3D Veterinary Locator</title>
    
    <!-- Google Fonts - Cherry Bomb One -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cherry+Bomb+One&display=swap" rel="stylesheet">
    
    <!-- MapLibre GL for 3D Maps -->
    <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Apply Cherry Bomb One font to specific elements */
        .top-search-bar,
        .section-title,
        .results-title,
        .modal-title,
        .result-name,
        .place-name {
            font-family: 'Cherry Bomb One', cursive;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background: #f0f8ff;
        }

        /* Full Screen Map */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Top Search Bar - Sky Blue Theme */
        .top-search-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 90%;
            z-index: 1000;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            background: rgba(135, 206, 235, 0.15);
            border: 1px solid rgba(135, 206, 235, 0.3);
            border-radius: 16px;
            padding: 12px 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .search-input-container {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            font-size: 16px;
            color: #333333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(77, 166, 255, 0.4);
            background: rgba(255, 255, 255, 1);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #4da6ff;
            font-size: 18px;
        }

        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .autocomplete-item {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(135, 206, 235, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333333;
        }

        .autocomplete-item:hover {
            background: rgba(77, 166, 255, 0.1);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .place-name {
            font-weight: 600;
            font-size: 14px;
            color: #222222;
        }

        .place-address {
            font-size: 12px;
            color: #666666;
            margin-top: 2px;
        }

        .search-action-buttons {
            display: flex;
            gap: 10px;
        }

        .search-btn, .location-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .search-btn {
            background: linear-gradient(135deg, #4da6ff 0%, #1a8cff 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(77, 166, 255, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 166, 255, 0.4);
        }

        .location-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #444444;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .location-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        /* Left Controls Panel */
        .left-controls-panel {
            position: absolute;
            top: 100px;
            left: 20px;
            width: 320px;
            z-index: 1000;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            background: rgba(135, 206, 235, 0.15);
            border: 1px solid rgba(135, 206, 235, 0.3);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .section-title {
            color: #333333;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: #4da6ff;
        }

        /* Radius Control */
        .radius-control {
            padding: 15px 0;
        }

        .radius-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .radius-label {
            color: #444444;
            font-weight: 500;
        }

        .radius-value {
            background: rgba(77, 166, 255, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .slider-container {
            position: relative;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 20px 0;
        }

        .slider-fill {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #4da6ff, #1a8cff);
            border-radius: 3px;
        }

        input[type="range"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .slider-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            color: #666666;
            font-size: 12px;
        }

        /* Service Filters */
        .service-filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .filter-btn {
            padding: 14px;
            border: 1px solid rgba(135, 206, 235, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #333333;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, rgba(77, 166, 255, 0.8), rgba(26, 140, 255, 0.8));
            border-color: rgba(77, 166, 255, 0.5);
            box-shadow: 0 4px 15px rgba(77, 166, 255, 0.2);
            color: white;
        }

        .filter-btn i {
            font-size: 20px;
            color: #4da6ff;
        }

        .filter-btn.active i {
            color: white;
        }

        .count-badge {
            background: rgba(77, 166, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            color: #333333;
        }

        .filter-btn.active .count-badge {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin-top: 5px;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .view-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            color: #444444;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: rgba(77, 166, 255, 0.2);
            color: #333333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Right Results Panel - FIXED HEIGHT ISSUE */
        .right-results-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 380px;
            z-index: 1000;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            background: rgba(135, 206, 235, 0.15);
            border: 1px solid rgba(135, 206, 235, 0.3);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(100vh - 140px);
            overflow: hidden;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .results-title {
            color: #333333;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .total-count {
            background: rgba(77, 166, 255, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .results-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            min-height: 0;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(135, 206, 235, 0.2);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            flex-shrink: 0;
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(77, 166, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-item.active {
            background: linear-gradient(135deg, rgba(77, 166, 255, 0.2), rgba(26, 140, 255, 0.2));
            border-color: rgba(77, 166, 255, 0.4);
        }

        .result-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #4da6ff 0%, #1a8cff 100%);
        }

        .result-name {
            font-weight: 600;
            color: #222222;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .result-type {
            font-size: 13px;
            color: #4da6ff;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .result-distance {
            font-size: 13px;
            color: #555555;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Route Info Panel */
        .route-info-panel {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            background: rgba(135, 206, 235, 0.15);
            border: 1px solid rgba(135, 206, 235, 0.3);
            border-radius: 16px;
            padding: 15px 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: none;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            width: 90%;
        }

        .route-info-panel.active {
            display: flex;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-title {
            font-family: 'Cherry Bomb One', cursive;
            color: #333333;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-route-btn {
            background: none;
            border: none;
            color: #666666;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-route-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #333333;
        }

        .route-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px 15px;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .route-distance, .route-duration {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .route-label {
            font-size: 12px;
            color: #666666;
        }

        .route-value {
            font-size: 16px;
            font-weight: 600;
            color: #333333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .route-navigation-btn {
            background: linear-gradient(135deg, #4da6ff 0%, #1a8cff 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .route-navigation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 166, 255, 0.4);
        }

        /* Bottom Center Controls - All 6 buttons combined */
        .bottom-center-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
            padding: 10px 20px;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
            background: rgba(135, 206, 235, 0.15);
            border: 1px solid rgba(135, 206, 235, 0.3);
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .map-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(135, 206, 235, 0.15);
            border: 1px solid rgba(135, 206, 235, 0.3);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333333;
            font-size: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .map-control-btn:hover {
            background: rgba(77, 166, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        /* Hide zoom-in button when at limit */
        .map-control-btn.zoom-hidden {
            display: none !important;
        }

        /* Location Permission Modal */
        .location-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .location-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            color: #333333;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: #4da6ff;
        }

        .modal-text {
            color: #555555;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #4da6ff 0%, #1a8cff 100%);
            color: white;
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 166, 255, 0.4);
        }

        .modal-btn.secondary {
            background: #f0f8ff;
            color: #444444;
            border: 1px solid rgba(77, 166, 255, 0.3);
        }

        .modal-btn.secondary:hover {
            background: #e6f2ff;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #4da6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #DDDDDD;
            font-size: 18px;
            font-weight: 500;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666666;
            flex-shrink: 0;
        }

        .no-results i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #AAAAAA;
        }

        .no-results p {
            font-size: 16px;
            margin-bottom: 5px;
            color: #444444;
        }

        .no-results .hint {
            font-size: 14px;
            color: #777777;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(77, 166, 255, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(77, 166, 255, 0.7);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .left-controls-panel {
                width: 300px;
            }
            
            .right-results-panel {
                width: 350px;
            }
            
            .bottom-center-controls {
                gap: 8px;
                padding: 10px 15px;
            }
            
            .map-control-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        @media (max-width: 1024px) {
            .top-search-bar {
                width: 90%;
            }
            
            .left-controls-panel {
                top: 120px;
                width: 280px;
            }
            
            .right-results-panel {
                top: 120px;
                width: 320px;
            }
            
            .search-btn, .location-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .bottom-center-controls {
                bottom: 15px;
                gap: 6px;
                padding: 8px 12px;
            }
            
            .map-control-btn {
                width: 42px;
                height: 42px;
                font-size: 17px;
            }
        }

        @media (max-width: 768px) {
            .top-search-bar {
                width: 95%;
                padding: 10px 15px;
            }
            
            .search-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-action-buttons {
                width: 100%;
            }
            
            .search-btn, .location-btn {
                flex: 1;
                justify-content: center;
            }
            
            .left-controls-panel, .right-results-panel {
                position: relative;
                width: 100%;
                max-width: 100%;
                margin: 10px;
                top: auto;
                left: auto;
                right: auto;
                max-height: 300px;
            }
            
            .bottom-center-controls {
                display: none;
            }
        }

        @media (max-width: 640px) {
            .bottom-center-controls {
                display: none;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .bottom-center-controls {
                gap: 4px;
                padding: 6px 10px;
                bottom: 10px;
            }
            
            .map-control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(45, 55, 72, 0.9);
            color: #DDDDDD;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 10000;
            margin-bottom: 8px;
            backdrop-filter: blur(2.5px);
            -webkit-backdrop-filter: blur(2.5px);
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(45, 55, 72, 0.9);
            margin-bottom: 2px;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <!-- Full Screen Map -->
    <div id="map">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">Finding pet services near you...</div>
        </div>
    </div>

    <!-- Top Search Bar -->
    <div class="top-search-bar">
        <div class="search-container">
            <div class="search-input-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Enter your city, area, or neighborhood...">
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
            <div class="search-action-buttons">
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-search"></i> Search
                </button>
                <button class="location-btn" id="useCurrentLocation">
                    <i class="fas fa-location-dot"></i> My Location
                </button>
            </div>
        </div>
    </div>

    <!-- Left Controls Panel -->
    <div class="left-controls-panel">
        <div class="panel-section">
            <div class="section-title">
                <i class="fas fa-ruler"></i> Search Radius
            </div>
            <div class="radius-control">
                <div class="radius-header">
                    <span class="radius-label">Distance</span>
                    <span class="radius-value" id="radiusValue">50 km</span>
                </div>
                <div class="slider-container">
                    <div class="slider-fill" style="width: 100%"></div>
                    <input type="range" id="radiusSlider" min="1" max="50" value="50" step="1">
                </div>
                <div class="slider-marks">
                    <span>1 km</span>
                    <span>25 km</span>
                    <span>50 km</span>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title">
                <i class="fas fa-filter"></i> Service Types
            </div>
            <div class="service-filters">
                <button class="filter-btn active" data-type="veterinary">
                    <i class="fas fa-stethoscope"></i>
                    <span>Veterinary</span>
                    <span class="count-badge" id="vetCount">0</span>
                </button>
                <button class="filter-btn active" data-type="pet_shop">
                    <i class="fas fa-store"></i>
                    <span>Pet Shop</span>
                    <span class="count-badge" id="petShopCount">0</span>
                </button>
                <button class="filter-btn" data-type="pet_grooming">
                    <i class="fas fa-shower"></i>
                    <span>Grooming</span>
                    <span class="count-badge" id="groomingCount">0</span>
                </button>
                <button class="filter-btn" data-type="animal_boarding">
                    <i class="fas fa-hotel"></i>
                    <span>Boarding</span>
                    <span class="count-badge" id="boardingCount">0</span>
                </button>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title">
                <i class="fas fa-map"></i> Map View
            </div>
            <div class="view-toggle">
                <button class="view-btn active" data-view="3D">
                    <i class="fas fa-cube"></i> 3D
                </button>
                <button class="view-btn" data-view="2D">
                    <i class="fas fa-map"></i> 2D
                </button>
            </div>
        </div>
    </div>

    <!-- Right Results Panel -->
    <div class="right-results-panel">
        <div class="results-header">
            <div class="results-title">
                <i class="fas fa-list"></i> Results
            </div>
            <div class="total-count">
                <span id="totalCount">0</span> found
            </div>
        </div>
        <div class="results-list" id="resultsList">
            <div class="no-results">
                <i class="fas fa-search-location"></i>
                <p>Search for pet services to see results</p>
                <p class="hint">Adjust filters or search location</p>
            </div>
        </div>
    </div>

    <!-- Route Information Panel -->
    <div class="route-info-panel" id="routeInfoPanel">
        <div class="route-header">
            <div class="route-title">
                <i class="fas fa-route"></i>
                Route to Service
            </div>
            <button class="close-route-btn" id="closeRouteBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="route-details">
            <div class="route-distance">
                <div class="route-label">Distance</div>
                <div class="route-value" id="routeDistance">-- km</div>
            </div>
            <div class="route-duration">
                <div class="route-label">Estimated Time</div>
                <div class="route-value" id="routeDuration">-- min</div>
            </div>
            <button class="route-navigation-btn" id="navigationBtn">
                <i class="fas fa-directions"></i>
                Get Directions
            </button>
        </div>
    </div>

    <!-- Bottom Center Controls - All 6 buttons combined horizontally -->
    <div class="bottom-center-controls">
        <!-- Original Top Left Controls -->
        <button class="map-control-btn tooltip" data-tooltip="Reset View" id="resetView">
            <i class="fas fa-home"></i>
        </button>
        <button class="map-control-btn tooltip" data-tooltip="Current Location" id="locateBtn">
            <i class="fas fa-location-crosshairs"></i>
        </button>
        <button class="map-control-btn tooltip" data-tooltip="Toggle 2D/3D" id="viewToggleBtn">
            <i class="fas fa-cube"></i>
        </button>
        
        <!-- Original Bottom Right Controls -->
        <button class="map-control-btn tooltip" data-tooltip="Zoom In" id="zoomInBtn">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn tooltip" data-tooltip="Zoom Out" id="zoomOutBtn">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn tooltip" data-tooltip="Reset North" id="resetNorthBtn">
            <i class="fas fa-compass"></i>
        </button>
    </div>

    <!-- Location Permission Modal -->
    <div class="location-modal" id="locationModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-map-marker-alt"></i>
                Location Access
            </div>
            <div class="modal-text">
                <p>To find pet services near you, we need your location. You can either:</p>
                <ol style="margin: 10px 0 10px 20px;">
                    <li>Allow location access for automatic detection</li>
                    <li>Type your city or area in the search bar</li>
                </ol>
                <p>Your location data is used only to show nearby services and is not stored.</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="allowLocation">
                    Allow Location
                </button>
                <button class="modal-btn secondary" id="skipLocation">
                    Enter Manually
                </button>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // CENTRALIZED CONFIGURATION
        // ================================
        const ZOOMGYAAAHHH = 24;
        const ZOOMLIMIT = 10;
        
        // ================================
        // STATE MANAGEMENT
        // ================================
        const state = {
            map: null,
            userLocation: null,
            currentView: '3D',
            activeFilters: ['veterinary', 'pet_shop'],
            searchRadius: 50, // Changed from 5 to 50 km
            markers: [],
            searchResults: [],
            selectedId: null,
            searchLocation: null,
            isLoading: false,
            autocompleteTimeout: null,
            locationPermissionAsked: false,
            locationPermissionGranted: false,
            zoomCounter: 0,
            zoomLimitReached: false,
            defaultCountry: 'IN',
            defaultCity: 'New Delhi',
            defaultCoordinates: [77.2090, 28.6139],
            routeLayerId: null,
            routeSourceId: null,
            currentRoute: null
        };

        // ================================
        // ELEMENTS CACHE
        // ================================
        const elements = {
            map: document.getElementById('map'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            locationModal: document.getElementById('locationModal'),
            allowLocation: document.getElementById('allowLocation'),
            skipLocation: document.getElementById('skipLocation'),
            searchInput: document.getElementById('searchInput'),
            autocompleteDropdown: document.getElementById('autocompleteDropdown'),
            searchBtn: document.getElementById('searchBtn'),
            useCurrentLocation: document.getElementById('useCurrentLocation'),
            radiusSlider: document.getElementById('radiusSlider'),
            radiusValue: document.getElementById('radiusValue'),
            sliderFill: document.querySelector('.slider-fill'),
            filterButtons: document.querySelectorAll('.filter-btn'),
            viewButtons: document.querySelectorAll('.view-btn'),
            resultsList: document.getElementById('resultsList'),
            totalCount: document.getElementById('totalCount'),
            vetCount: document.getElementById('vetCount'),
            petShopCount: document.getElementById('petShopCount'),
            groomingCount: document.getElementById('groomingCount'),
            boardingCount: document.getElementById('boardingCount'),
            resetView: document.getElementById('resetView'),
            locateBtn: document.getElementById('locateBtn'),
            viewToggleBtn: document.getElementById('viewToggleBtn'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            resetNorthBtn: document.getElementById('resetNorthBtn'),
            routeInfoPanel: document.getElementById('routeInfoPanel'),
            closeRouteBtn: document.getElementById('closeRouteBtn'),
            routeDistance: document.getElementById('routeDistance'),
            routeDuration: document.getElementById('routeDuration'),
            navigationBtn: document.getElementById('navigationBtn')
        };

        // ================================
        // INITIALIZATION
        // ================================
        function init() {
            initMap();
            setupEventListeners();
            setLoading(false);
            
            updateSliderFill();
            updateFilterButtons();
            updateViewButtons();
            
            setTimeout(() => {
                useDefaultLocation();
            }, 1000);
        }

        // ================================
        // MAP INITIALIZATION
        // ================================
        function initMap() {
            state.map = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    sources: {
                        'osm-tiles': {
                            type: 'raster',
                            tiles: [
                                'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
                                'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
                                'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
                            ],
                            tileSize: 256,
                            attribution: 'Â© OpenStreetMap contributors',
                            maxzoom: ZOOMGYAAAHHH
                        }
                    },
                    layers: [{
                        id: 'background',
                        type: 'background',
                        paint: {
                            'background-color': '#f0f8ff'
                        }
                    }, {
                        id: 'osm-tiles-layer',
                        type: 'raster',
                        source: 'osm-tiles',
                        minzoom: 0,
                        maxzoom: ZOOMGYAAAHHH
                    }]
                },
                center: state.defaultCoordinates,
                zoom: 10,
                pitch: 60,
                bearing: 0,
                maxZoom: ZOOMGYAAAHHH,
                minZoom: 1
            });

            state.map.on('zoom', () => {
                const currentZoom = state.map.getZoom();
                if (currentZoom > ZOOMGYAAAHHH) {
                    state.map.setZoom(ZOOMGYAAAHHH);
                }
                checkZoomButtonVisibility();
            });

            state.map.on('error', (e) => {
                console.log('Map error:', e.error);
            });

            state.map.on('load', () => {
                console.log('Map loaded successfully');
                setLoading(false);
                checkZoomButtonVisibility();
                
                // Add route source and layer
                state.map.addSource('route', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: []
                    }
                });
                
                state.map.addLayer({
                    id: 'route-line',
                    type: 'line',
                    source: 'route',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#4da6ff',
                        'line-width': 4,
                        'line-opacity': 0.8,
                        'line-dasharray': [1, 1]
                    }
                });
                
                state.routeSourceId = 'route';
                state.routeLayerId = 'route-line';
            });

            state.map.on('click', () => {
                clearSelection();
            });
        }

        // ================================
        // ZOOM BUTTON VISIBILITY CONTROL
        // ================================
        function checkZoomButtonVisibility() {
            const currentZoom = state.map.getZoom();
            
            if (state.zoomCounter >= ZOOMLIMIT && !state.zoomLimitReached) {
                elements.zoomInBtn.classList.add('zoom-hidden');
                state.zoomLimitReached = true;
            }
            
            if (currentZoom < 10 && state.zoomLimitReached) {
                elements.zoomInBtn.classList.remove('zoom-hidden');
                state.zoomCounter = 0;
                state.zoomLimitReached = false;
            }
        }

        // ================================
        // EVENT LISTENERS
        // ================================
        function setupEventListeners() {
            // Search input with autocomplete
            elements.searchInput.addEventListener('input', handleSearchInput);
            elements.searchInput.addEventListener('focus', () => {
                if (elements.searchInput.value.length > 2) {
                    searchAutocomplete(elements.searchInput.value);
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-input-container')) {
                    elements.autocompleteDropdown.style.display = 'none';
                }
            });
            
            // Search button
            elements.searchBtn.addEventListener('click', () => {
                handleSearch(elements.searchInput.value.trim());
            });
            
            elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch(elements.searchInput.value.trim());
                }
            });
            
            // Location button
            elements.useCurrentLocation.addEventListener('click', () => {
                if (!state.locationPermissionAsked) {
                    showLocationModal();
                } else if (state.locationPermissionGranted) {
                    getUserLocation(true);
                } else {
                    showLocationModal();
                }
            });
            
            // Location modal buttons
            elements.allowLocation.addEventListener('click', () => {
                elements.locationModal.classList.remove('active');
                getUserLocation(true);
            });
            
            elements.skipLocation.addEventListener('click', () => {
                elements.locationModal.classList.remove('active');
                elements.searchInput.focus();
                showMessage(`Enter your city or area. Try "${state.defaultCity}" or your locality name.`);
            });
            
            // Radius slider - UPDATED for 50 km max
            elements.radiusSlider.addEventListener('input', (e) => {
                state.searchRadius = parseInt(e.target.value);
                elements.radiusValue.textContent = `${state.searchRadius} km`;
                updateSliderFill();
                
                if (state.searchResults.length > 0) {
                    searchNearbyServices();
                }
            });
            
            // Filter buttons
            elements.filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const index = state.activeFilters.indexOf(type);
                    
                    if (index === -1) {
                        state.activeFilters.push(type);
                        btn.classList.add('active');
                    } else {
                        state.activeFilters.splice(index, 1);
                        btn.classList.remove('active');
                    }
                    
                    updateFilterCounts();
                    
                    if (state.searchResults.length > 0) {
                        filterAndDisplayResults();
                    }
                });
            });
            
            // View toggle buttons
            elements.viewButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    if (view !== state.currentView) {
                        toggleMapView(view);
                    }
                });
            });
            
            // Control buttons
            elements.resetView.addEventListener('click', resetMapView);
            elements.locateBtn.addEventListener('click', () => {
                if (!state.locationPermissionAsked) {
                    showLocationModal();
                } else if (state.locationPermissionGranted) {
                    getUserLocation(true);
                } else {
                    showMessage('Please enter your location in the search bar.');
                }
            });
            elements.viewToggleBtn.addEventListener('click', toggle3DView);
            
            // Zoom buttons
            elements.zoomInBtn.addEventListener('click', () => {
                const currentZoom = state.map.getZoom();
                if (currentZoom < ZOOMGYAAAHHH) {
                    state.map.zoomIn();
                    state.zoomCounter++;
                    
                    if (state.zoomCounter >= ZOOMLIMIT) {
                        elements.zoomInBtn.classList.add('zoom-hidden');
                        state.zoomLimitReached = true;
                        showMessage(`Zoom limit reached (${ZOOMLIMIT} times)`);
                    }
                } else {
                    showMessage(`Maximum zoom level reached (${ZOOMGYAAAHHH})`);
                }
            });
            
            elements.zoomOutBtn.addEventListener('click', () => {
                const currentZoom = state.map.getZoom();
                if (currentZoom > 1) {
                    state.map.zoomOut();
                    
                    if (currentZoom <= 10) {
                        if (state.zoomLimitReached) {
                            elements.zoomInBtn.classList.remove('zoom-hidden');
                            state.zoomCounter = 0;
                            state.zoomLimitReached = false;
                        }
                    }
                }
            });
            
            elements.resetNorthBtn.addEventListener('click', () => {
                state.map.resetNorth();
            });
            
            // Route panel close button
            elements.closeRouteBtn.addEventListener('click', clearRoute);
            
            // Navigation button
            elements.navigationBtn.addEventListener('click', openNavigation);
            
            // Window resize handler
            window.addEventListener('resize', () => {
                if (state.map) {
                    setTimeout(() => state.map.resize(), 100);
                }
            });
        }

        // ================================
        // ROUTE FUNCTIONS
        // ================================
        async function calculateRoute(service) {
            if (!state.userLocation) {
                showMessage('Please enable location services to calculate route');
                return;
            }
            
            try {
                const start = [state.userLocation.lng, state.userLocation.lat];
                const end = [service.lng, service.lat];
                
                // Using OSRM API for routing
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${start[0]},${start[1]};${end[0]},${end[1]}?overview=full&geometries=geojson`
                );
                
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes.length > 0) {
                    const route = data.routes[0];
                    state.currentRoute = {
                        geometry: route.geometry,
                        distance: route.distance,
                        duration: route.duration
                    };
                    
                    // Update route info panel
                    elements.routeDistance.textContent = `${(route.distance / 1000).toFixed(1)} km`;
                    elements.routeDuration.textContent = `${Math.round(route.duration / 60)} min`;
                    
                    // Show route on map
                    showRouteOnMap(route.geometry);
                    
                    // Show route info panel
                    elements.routeInfoPanel.classList.add('active');
                } else {
                    showMessage('Unable to calculate route. Please try again.');
                }
            } catch (error) {
                console.error('Route calculation error:', error);
                showMessage('Error calculating route. Please check your connection.');
            }
        }

        function showRouteOnMap(routeGeometry) {
            if (!state.map.getSource(state.routeSourceId)) return;
            
            const routeFeature = {
                type: 'Feature',
                properties: {},
                geometry: routeGeometry
            };
            
            state.map.getSource(state.routeSourceId).setData({
                type: 'FeatureCollection',
                features: [routeFeature]
            });
            
            // Fit map to show the entire route
            const coordinates = routeGeometry.coordinates;
            const bounds = coordinates.reduce((bounds, coord) => {
                return bounds.extend(coord);
            }, new maplibregl.LngLatBounds(coordinates[0], coordinates[0]));
            
            state.map.fitBounds(bounds, {
                padding: 100,
                duration: 1000
            });
        }

        function clearRoute() {
            if (state.map.getSource(state.routeSourceId)) {
                state.map.getSource(state.routeSourceId).setData({
                    type: 'FeatureCollection',
                    features: []
                });
            }
            
            elements.routeInfoPanel.classList.remove('active');
            state.currentRoute = null;
        }

        function openNavigation() {
            if (!state.currentRoute || !state.selectedId) return;
            
            const service = state.searchResults.find(s => s.id === state.selectedId);
            if (!service) return;
            
            // Open Google Maps with directions
            const start = `${state.userLocation.lat},${state.userLocation.lng}`;
            const end = `${service.lat},${service.lng}`;
            const url = `https://www.google.com/maps/dir/?api=1&origin=${start}&destination=${end}&travelmode=driving`;
            
            window.open(url, '_blank');
        }

        // ================================
        // LOCATION FUNCTIONS
        // ================================
        function useDefaultLocation() {
            state.searchLocation = {
                lng: state.defaultCoordinates[0],
                lat: state.defaultCoordinates[1]
            };
            
            elements.searchInput.placeholder = `Enter location in ${state.defaultCity} or nearby...`;
            
            state.map.flyTo({
                center: state.defaultCoordinates,
                zoom: 10,
                essential: true
            });
            
            searchNearbyServices();
        }

        function showLocationModal() {
            state.locationPermissionAsked = true;
            elements.locationModal.classList.add('active');
        }

        function getUserLocation(shouldSearch = false) {
            state.locationPermissionAsked = true;
            
            if (!navigator.geolocation) {
                showMessage('Geolocation is not supported by your browser. Please enter your location manually.');
                elements.searchInput.focus();
                return;
            }
            
            setLoading(true);
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { longitude, latitude } = position.coords;
                    state.userLocation = { lng: longitude, lat: latitude };
                    state.searchLocation = state.userLocation;
                    state.locationPermissionGranted = true;
                    
                    state.map.flyTo({
                        center: [longitude, latitude],
                        zoom: 12,
                        essential: true
                    });
                    
                    setLoading(false);
                    
                    if (shouldSearch) {
                        searchNearbyServices();
                    }
                    
                    reverseGeocode(longitude, latitude);
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    state.locationPermissionGranted = false;
                    
                    let message = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Location access denied. Please enter your location manually.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Location unavailable. Please enter your city or area.';
                            break;
                        case error.TIMEOUT:
                            message = 'Location request timed out. Please try entering your location.';
                            break;
                        default:
                            message = 'Unable to get location. Please enter your city or area.';
                    }
                    
                    showMessage(message);
                    setLoading(false);
                    elements.searchInput.focus();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 600000
                }
            );
        }

        async function reverseGeocode(lng, lat) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=14`
                );
                const data = await response.json();
                
                if (data.address) {
                    const address = data.address;
                    let locationName = '';
                    
                    if (address.road) locationName += address.road + ', ';
                    if (address.suburb) locationName += address.suburb + ', ';
                    if (address.city || address.town || address.village) {
                        locationName += address.city || address.town || address.village;
                    }
                    
                    if (locationName) {
                        elements.searchInput.value = locationName;
                    }
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
            }
        }

        // ================================
        // SEARCH AUTOCOMPLETE
        // ================================
        function handleSearchInput(e) {
            const query = e.target.value.trim();
            if (query.length > 2) {
                clearTimeout(state.autocompleteTimeout);
                state.autocompleteTimeout = setTimeout(() => {
                    searchAutocomplete(query);
                }, 300);
            } else {
                elements.autocompleteDropdown.style.display = 'none';
            }
        }

        async function searchAutocomplete(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1&countrycodes=${state.defaultCountry}&bounded=1`
                );
                const results = await response.json();
                showAutocompleteResults(results);
            } catch (error) {
                console.error('Autocomplete error:', error);
            }
        }

        function showAutocompleteResults(results) {
            elements.autocompleteDropdown.innerHTML = '';
            
            if (results.length === 0) {
                elements.autocompleteDropdown.innerHTML = `
                    <div class="autocomplete-item" data-suggestion="local">
                        <div class="place-name">Try searching for:</div>
                        <div class="place-address">${state.defaultCity} areas, local landmarks, or neighborhoods</div>
                    </div>
                `;
                
                const suggestionItem = elements.autocompleteDropdown.querySelector('.autocomplete-item');
                suggestionItem.addEventListener('click', () => {
                    elements.searchInput.value = '';
                    elements.searchInput.focus();
                    elements.autocompleteDropdown.style.display = 'none';
                    showMessage(`Enter areas in ${state.defaultCity} like: Connaught Place, Karol Bagh, etc.`);
                });
                
                elements.autocompleteDropdown.style.display = 'block';
                return;
            }
            
            results.forEach(place => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div class="place-name">${getPlaceName(place)}</div>
                    <div class="place-address">${truncateAddress(place.display_name)}</div>
                `;
                
                item.addEventListener('click', () => {
                    elements.searchInput.value = getPlaceName(place);
                    elements.autocompleteDropdown.style.display = 'none';
                    handleSearch(place.display_name);
                });
                
                elements.autocompleteDropdown.appendChild(item);
            });
            
            elements.autocompleteDropdown.style.display = 'block';
        }

        function getPlaceName(place) {
            if (place.address) {
                if (place.address.road) {
                    return place.address.road;
                }
                if (place.address.suburb) {
                    return place.address.suburb;
                }
                if (place.address.neighbourhood) {
                    return place.address.neighbourhood;
                }
            }
            return place.display_name.split(',')[0];
        }

        function truncateAddress(address) {
            const parts = address.split(',');
            if (parts.length > 3) {
                return parts.slice(1, 4).join(',');
            }
            return address;
        }

        // ================================
        // SEARCH FUNCTIONALITY
        // ================================
        async function handleSearch(query) {
            elements.autocompleteDropdown.style.display = 'none';
            
            if (!query.trim()) {
                showMessage('Please enter a location to search');
                return;
            }
            
            setLoading(true);
            try {
                const results = await searchLocation(query);
                
                if (results.length > 0) {
                    const bestResult = results[0];
                    state.searchLocation = {
                        lng: parseFloat(bestResult.lon),
                        lat: parseFloat(bestResult.lat)
                    };
                    
                    elements.searchInput.value = formatAddress(bestResult);
                    
                    state.map.flyTo({
                        center: [bestResult.lon, bestResult.lat],
                        zoom: 12,
                        essential: true
                    });
                    
                    await searchNearbyServices();
                } else {
                    showMessage(`No results found in ${state.defaultCity}. Try local areas or landmarks.`);
                    setLoading(false);
                }
            } catch (error) {
                console.error('Search error:', error);
                showMessage('Error searching location. Please try again.');
                setLoading(false);
            }
        }

        async function searchLocation(query) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1&countrycodes=${state.defaultCountry}&bounded=1`
                );
                const results = await response.json();
                
                if (results.length > 0) {
                    return results;
                }
                
                const fallbackResponse = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=3`
                );
                return await fallbackResponse.json();
                
            } catch (error) {
                console.error('Location search error:', error);
                return [];
            }
        }

        function formatAddress(result) {
            if (result.address) {
                const addr = result.address;
                const parts = [];
                
                if (addr.road) parts.push(addr.road);
                if (addr.suburb) parts.push(addr.suburb);
                if (addr.neighbourhood) parts.push(addr.neighbourhood);
                if (addr.city || addr.town || addr.village) {
                    parts.push(addr.city || addr.town || addr.village);
                }
                
                return parts.join(', ') || result.display_name;
            }
            return result.display_name || `${result.lat}, ${result.lon}`;
        }

        // ================================
        // SERVICE SEARCH (MOCK DATA)
        // ================================
        async function searchNearbyServices() {
            setLoading(true);
            clearMarkers();
            clearRoute();
            state.searchResults = [];
            state.selectedId = null;
            
            const center = state.searchLocation || state.userLocation || state.map.getCenter();
            
            if (!center) {
                showMessage('Please provide a location to search from.');
                setLoading(false);
                return;
            }
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const mockServices = generateMockServices(center, state.searchRadius);
            
            state.searchResults = mockServices.filter(service => 
                state.activeFilters.includes(service.type)
            );
            
            state.searchResults.sort((a, b) => a.distance - b.distance);
            
            updateFilterCounts();
            displayResults();
            addMarkers();
            
            setLoading(false);
            
            if (state.searchResults.length === 0) {
                showNoResults();
            }
        }

        function generateMockServices(center, radius) {
            const services = [];
            const serviceTypes = [
                { type: 'veterinary', icon: 'fas fa-stethoscope', color: '#4da6ff' },
                { type: 'pet_shop', icon: 'fas fa-store', color: '#4da6ff' },
                { type: 'pet_grooming', icon: 'fas fa-shower', color: '#4da6ff' },
                { type: 'animal_boarding', icon: 'fas fa-hotel', color: '#4da6ff' }
            ];
            
            // Increased number of services for 50 km radius
            const numServices = Math.floor(Math.random() * 20) + 25;
            
            for (let i = 0; i < numServices; i++) {
                const typeIndex = Math.floor(Math.random() * serviceTypes.length);
                const serviceType = serviceTypes[typeIndex];
                
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * radius;
                
                const lat = center.lat + (distance / 111.32) * Math.cos(angle);
                const lng = center.lng + (distance / (111.32 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle);
                
                const service = {
                    id: `service-${Date.now()}-${i}`,
                    name: getRandomServiceName(serviceType.type, i),
                    type: serviceType.type,
                    category: getServiceCategoryName(serviceType.type),
                    lat: lat,
                    lng: lng,
                    distance: parseFloat(distance.toFixed(2)),
                    address: `${Math.floor(Math.random() * 1000) + 1} Local Street`,
                    phone: `+91 ${Math.floor(Math.random() * 90000) + 10000} ${Math.floor(Math.random() * 90000) + 10000}`,
                    rating: (Math.random() * 2 + 3).toFixed(1),
                    icon: serviceType.icon,
                    color: serviceType.color,
                    open: Math.random() > 0.3
                };
                
                services.push(service);
            }
            
            return services;
        }

        function getRandomServiceName(type, index) {
            const prefixes = {
                veterinary: ['PetCare', 'Animal', 'Vet', 'Emergency', 'Family', 'City', 'Happy', 'Safe'],
                pet_shop: ['Pet', 'Furry', 'Happy', 'Super', 'Mega', 'Best', 'Paws', 'Tail'],
                pet_grooming: ['Groom', 'Pretty', 'Clean', 'Fancy', 'Sparkle', 'Royal', 'Pampered', 'Fresh'],
                animal_boarding: ['PetStay', 'HappyPaws', 'Comfy', 'Safe', 'Vacay', 'Luxury', 'Cozy', 'PetPalace']
            };
            
            const suffixes = {
                veterinary: ['Veterinary Clinic', 'Animal Hospital', 'Vet Center', 'Pet Clinic', 'Care Center'],
                pet_shop: ['Pet Store', 'Pet Supplies', 'Pet Shop', 'Pet Mart', 'Pet World'],
                pet_grooming: ['Grooming Salon', 'Pet Spa', 'Grooming Center', 'Pet Groomers', 'Beauty Parlor'],
                animal_boarding: ['Boarding', 'Pet Hotel', 'Kennels', 'Pet Resort', 'Lodging']
            };
            
            const prefixArray = prefixes[type];
            const suffixArray = suffixes[type];
            const prefix = prefixArray[index % prefixArray.length];
            const suffix = suffixArray[Math.floor(Math.random() * suffixArray.length)];
            
            return `${prefix} ${suffix}`;
        }

        function getServiceCategoryName(type) {
            const names = {
                veterinary: 'Veterinary Clinic',
                pet_shop: 'Pet Shop',
                pet_grooming: 'Grooming Service',
                animal_boarding: 'Boarding Facility'
            };
            return names[type] || type;
        }

        // ================================
        // MAP MARKERS
        // ================================
        function addMarkers() {
            clearMarkers();
            
            state.searchResults.forEach(service => {
                const el = document.createElement('div');
                el.className = 'custom-marker';
                el.dataset.id = service.id;
                el.style.cssText = `
                    width: 42px;
                    height: 42px;
                    background: ${service.color};
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 18px;
                    border: 3px solid white;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    transform: ${service.id === state.selectedId ? 'scale(1.2)' : 'scale(1)'};
                    z-index: ${service.id === state.selectedId ? '1000' : '1'};
                `;
                
                if (service.id === state.selectedId) {
                    el.style.animation = 'pulse 2s infinite';
                }
                
                const icon = document.createElement('i');
                icon.className = service.icon;
                el.appendChild(icon);
                
                const marker = new maplibregl.Marker({
                    element: el,
                    anchor: 'bottom'
                })
                .setLngLat([service.lng, service.lat])
                .addTo(state.map);
                
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectPlace(service.id);
                });
                
                state.markers.push({
                    id: service.id,
                    marker: marker,
                    element: el,
                    service: service
                });
            });
        }

        function clearMarkers() {
            state.markers.forEach(marker => marker.marker.remove());
            state.markers = [];
        }

        // ================================
        // RESULTS DISPLAY
        // ================================
        function displayResults() {
            elements.resultsList.innerHTML = '';
            
            if (state.searchResults.length === 0) {
                showNoResults();
                return;
            }
            
            state.searchResults.forEach(service => {
                const item = document.createElement('div');
                item.className = 'result-item';
                if (service.id === state.selectedId) {
                    item.classList.add('active');
                }
                
                item.dataset.id = service.id;
                item.innerHTML = `
                    <div class="result-name">${service.name}</div>
                    <div class="result-type">
                        <i class="${service.icon}"></i>
                        ${service.category}
                        <span style="margin-left: auto; font-size: 12px; color: ${service.open ? '#4CAF50' : '#F44336'}">
                            <i class="fas fa-circle"></i> ${service.open ? 'Open' : 'Closed'}
                        </span>
                    </div>
                    <div class="result-distance">
                        <i class="fas fa-location-dot"></i>
                        ${service.distance.toFixed(1)} km
                        <span style="margin-left: auto; color: #FF9800; font-size: 12px;">
                            <i class="fas fa-star"></i> ${service.rating}
                        </span>
                    </div>
                `;
                
                item.addEventListener('click', () => selectPlace(service.id));
                
                elements.resultsList.appendChild(item);
            });
        }

        function showNoResults() {
            elements.resultsList.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search-location"></i>
                    <p>No services found in this area</p>
                    <p class="hint">Try adjusting your search radius or location</p>
                </div>
            `;
        }

        function filterAndDisplayResults() {
            const filteredResults = state.searchResults.filter(service => 
                state.activeFilters.includes(service.type)
            );
            
            state.searchResults = filteredResults;
            updateFilterCounts();
            displayResults();
            addMarkers();
            
            if (filteredResults.length === 0) {
                showNoResults();
            }
        }

        // ================================
        // SELECTION FUNCTIONS WITH ROUTE
        // ================================
        function selectPlace(id) {
            clearSelection();
            state.selectedId = id;
            
            document.querySelectorAll('.result-item').forEach(item => {
                if (item.dataset.id === id) {
                    item.classList.add('active');
                }
            });
            
            state.markers.forEach(marker => {
                if (marker.id === id) {
                    marker.element.style.transform = 'scale(1.3)';
                    marker.element.style.zIndex = '1000';
                    marker.element.style.animation = 'pulse 2s infinite';
                    
                    const service = marker.service;
                    
                    // Calculate and show route if user location is available
                    if (state.userLocation) {
                        calculateRoute(service);
                    } else {
                        // Just zoom to service if no user location
                        state.map.flyTo({
                            center: [service.lng, service.lat],
                            zoom: Math.min(16, ZOOMGYAAAHHH),
                            pitch: state.currentView === '3D' ? 60 : 0,
                            essential: true
                        });
                    }
                    
                    const popup = new maplibregl.Popup({
                        closeButton: true,
                        closeOnClick: false,
                        offset: 25
                    })
                    .setLngLat([service.lng, service.lat])
                    .setHTML(`
                        <div style="padding: 10px; min-width: 200px;">
                            <h4 style="margin: 0 0 8px 0; color: #222222; font-family: 'Cherry Bomb One', cursive;">${service.name}</h4>
                            <p style="margin: 0 0 6px 0; color: #4da6ff;">
                                <i class="${service.icon}"></i> ${service.category}
                            </p>
                            <p style="margin: 0 0 6px 0; color: #555555; font-size: 14px;">
                                <i class="fas fa-location-dot"></i> ${service.distance.toFixed(1)} km away
                            </p>
                            <p style="margin: 0 0 6px 0; color: #555555; font-size: 14px;">
                                <i class="fas fa-phone"></i> ${service.phone}
                            </p>
                            <p style="margin: 0; color: ${service.open ? '#4CAF50' : '#F44336'}; font-size: 14px;">
                                <i class="fas fa-circle"></i> ${service.open ? 'Open Now' : 'Currently Closed'}
                            </p>
                        </div>
                    `)
                    .addTo(state.map);
                    
                    marker.popup = popup;
                }
            });
        }

        function clearSelection() {
            state.selectedId = null;
            
            document.querySelectorAll('.result-item').forEach(item => {
                item.classList.remove('active');
            });
            
            state.markers.forEach(marker => {
                marker.element.style.transform = 'scale(1)';
                marker.element.style.animation = 'none';
                marker.element.style.zIndex = '1';
                
                if (marker.popup) {
                    marker.popup.remove();
                    marker.popup = null;
                }
            });
            
            clearRoute();
        }

        // ================================
        // UI UPDATE FUNCTIONS
        // ================================
        function updateFilterCounts() {
            const counts = {
                veterinary: 0,
                pet_shop: 0,
                pet_grooming: 0,
                animal_boarding: 0
            };
            
            state.searchResults.forEach(result => {
                if (counts[result.type] !== undefined) {
                    counts[result.type]++;
                }
            });
            
            elements.vetCount.textContent = counts.veterinary;
            elements.petShopCount.textContent = counts.pet_shop;
            elements.groomingCount.textContent = counts.pet_grooming;
            elements.boardingCount.textContent = counts.animal_boarding;
            elements.totalCount.textContent = state.searchResults.length;
        }

        function updateSliderFill() {
            const percentage = ((state.searchRadius - 1) / 49) * 100; // Updated for 1-50 range
            elements.sliderFill.style.width = `${percentage}%`;
        }

        function updateFilterButtons() {
            elements.filterButtons.forEach(btn => {
                const type = btn.dataset.type;
                if (state.activeFilters.includes(type)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function updateViewButtons() {
            elements.viewButtons.forEach(btn => {
                if (btn.dataset.view === state.currentView) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // ================================
        // MAP VIEW FUNCTIONS
        // ================================
        function toggleMapView(view) {
            state.currentView = view;
            
            if (view === '3D') {
                state.map.flyTo({
                    pitch: 60,
                    bearing: 0,
                    essential: true
                });
                elements.viewToggleBtn.innerHTML = '<i class="fas fa-cube"></i>';
                elements.viewToggleBtn.setAttribute('data-tooltip', 'Switch to 2D View');
            } else {
                state.map.flyTo({
                    pitch: 0,
                    bearing: 0,
                    essential: true
                });
                elements.viewToggleBtn.innerHTML = '<i class="fas fa-map"></i>';
                elements.viewToggleBtn.setAttribute('data-tooltip', 'Switch to 3D View');
            }
            
            updateViewButtons();
        }

        function toggle3DView() {
            const newView = state.currentView === '3D' ? '2D' : '3D';
            toggleMapView(newView);
        }

        function resetMapView() {
            const center = state.userLocation || state.searchLocation || state.defaultCoordinates;
            state.map.flyTo({
                center: center,
                zoom: state.userLocation ? 12 : 10,
                pitch: state.currentView === '3D' ? 60 : 0,
                bearing: 0,
                essential: true
            });
            
            if (state.zoomLimitReached) {
                elements.zoomInBtn.classList.remove('zoom-hidden');
                state.zoomCounter = 0;
                state.zoomLimitReached = false;
            }
        }

        // ================================
        // UTILITY FUNCTIONS
        // ================================
        function setLoading(isLoading) {
            state.isLoading = isLoading;
            if (isLoading) {
                elements.loadingOverlay.classList.add('active');
            } else {
                elements.loadingOverlay.classList.remove('active');
            }
        }

        function showMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(45, 55, 72, 0.9);
                color: #DDDDDD;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease;
                backdrop-filter: blur(2.5px);
                -webkit-backdrop-filter: blur(2.5px);
                border: 1px solid rgba(135, 206, 235, 0.3);
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="color: #4da6ff;"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
            
            if (!document.getElementById('toast-animations')) {
                const style = document.createElement('style');
                style.id = 'toast-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translate(-50%, -100%); opacity: 0; }
                        to { transform: translate(-50%, 0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translate(-50%, 0); opacity: 1; }
                        to { transform: translate(-50%, -100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ================================
        // INITIALIZE APPLICATION
        // ================================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>